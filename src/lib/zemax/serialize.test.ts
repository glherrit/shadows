// tests/demo.js

import Lens, { Material, Surface } from '$lib/lens'
import { makeCollimatedFlattop } from '../lightSource'
import { serializeToZemax } from './serialize'

const ONE_MICRON_SOURCE = makeCollimatedFlattop(5.5, 1.07)

const TEN_MICRON_SOURCE = makeCollimatedFlattop(11.0, 10.6)

const THREE_MICRON_SOURCE = makeCollimatedFlattop(5.0, 3.39)

test('POCX w/ conic', () => {
  const zemaxText = serializeToZemax(
    new Lens(
      25,
      5,
      Material.FusedSilica,
      new Surface(25, 1 / 44.966, -0.57922),
      new Surface(25, 0)
    ),
    ONE_MICRON_SOURCE
  )

  expect(zemaxText).toBe(`MODE SEQ
UNIT MM X W X CM MR CPMM
ENPD 11
ENVD 20 1 0
GFAC 0 0
GCAT SCHOTT MISC INFRARED
RAIM 0 0 1 1 0 0 0 0 0 1
FTYP 0 0 1 1 0 0 0 1
WAVM 1 1.07 1
PWAV 1
POLS 1 0 1 0 0 1 0
GLRS 1 0
GSTD 0 100.000 100.000 100.000 100.000 100.000 100.000 0 1 1 0 0 1 1 1 1 1 1
NSCD 100 500 0 0.001 10 9.9999999999999995e-07 0 0 0 0 0 0 1000000 0 2
COFN QF "COATING.DAT" "SCATTER_PROFILE.DAT" "ABG_DATA.DAT" "PROFILE.GRD"
COFN COATING.DAT SCATTER_PROFILE.DAT ABG_DATA.DAT PROFILE.GRD
LUID 4
SURF 0
  TYPE STANDARD
  CURV 0.0
  DISZ INFINITY
SURF 1
  STOP
  CURV 0.022239025041142196
  CONI -0.57922
  TYPE STANDARD
  DIAM 12.5 1 0 0
  MEMA 12.5 1 0 0
  DISZ 5
  GLAS SILICA
SURF 2
  CURV 0
  TYPE STANDARD
  DIAM 12.5 1 0 0
  MEMA 12.5 1 0 0
  DISZ 0
SURF 3
  TYPE STANDARD
  CURV 0.0
  SLAB 4
  DISZ 96.55091538705629
  MAZH 0 0
SURF 4
  TYPE STANDARD
  CURV 0.0
  DISZ 0`)
})

test('POSMEN wo aspheres', () => {
  const zemaxText = serializeToZemax(
    new Lens(27.94, 6, Material.ZnSe, new Surface(27.94, 1 / 114), new Surface(27.94, 1 / 308.5)),
    TEN_MICRON_SOURCE
  )

  expect(zemaxText).toBe(`MODE SEQ
UNIT MM X W X CM MR CPMM
ENPD 22
ENVD 20 1 0
GFAC 0 0
GCAT SCHOTT MISC INFRARED
RAIM 0 0 1 1 0 0 0 0 0 1
FTYP 0 0 1 1 0 0 0 1
WAVM 1 10.6 1
PWAV 1
POLS 1 0 1 0 0 1 0
GLRS 1 0
GSTD 0 100.000 100.000 100.000 100.000 100.000 100.000 0 1 1 0 0 1 1 1 1 1 1
NSCD 100 500 0 0.001 10 9.9999999999999995e-07 0 0 0 0 0 0 1000000 0 2
COFN QF "COATING.DAT" "SCATTER_PROFILE.DAT" "ABG_DATA.DAT" "PROFILE.GRD"
COFN COATING.DAT SCATTER_PROFILE.DAT ABG_DATA.DAT PROFILE.GRD
LUID 4
SURF 0
  TYPE STANDARD
  CURV 0.0
  DISZ INFINITY
SURF 1
  STOP
  CURV 0.008771929824561403
  TYPE STANDARD
  DIAM 13.97 1 0 0
  MEMA 13.97 1 0 0
  DISZ 6
  GLAS ZNSE
SURF 2
  CURV 0.0032414910858995136
  TYPE STANDARD
  DIAM 13.97 1 0 0
  MEMA 13.97 1 0 0
  DISZ 0
SURF 3
  TYPE STANDARD
  CURV 0.0
  SLAB 4
  DISZ 122.73364613991463
  MAZH 0 0
SURF 4
  TYPE STANDARD
  CURV 0.0
  DISZ 0`)
})

test('BICX wo aspheres', () => {
  const zemaxText = serializeToZemax(
    new Lens(25, 7.5, Material.ZnSe, new Surface(25, 1 / 200), new Surface(25, -1 / 200)),
    TEN_MICRON_SOURCE
  )

  expect(zemaxText).toBe(`MODE SEQ
UNIT MM X W X CM MR CPMM
ENPD 22
ENVD 20 1 0
GFAC 0 0
GCAT SCHOTT MISC INFRARED
RAIM 0 0 1 1 0 0 0 0 0 1
FTYP 0 0 1 1 0 0 0 1
WAVM 1 10.6 1
PWAV 1
POLS 1 0 1 0 0 1 0
GLRS 1 0
GSTD 0 100.000 100.000 100.000 100.000 100.000 100.000 0 1 1 0 0 1 1 1 1 1 1
NSCD 100 500 0 0.001 10 9.9999999999999995e-07 0 0 0 0 0 0 1000000 0 2
COFN QF "COATING.DAT" "SCATTER_PROFILE.DAT" "ABG_DATA.DAT" "PROFILE.GRD"
COFN COATING.DAT SCATTER_PROFILE.DAT ABG_DATA.DAT PROFILE.GRD
LUID 4
SURF 0
  TYPE STANDARD
  CURV 0.0
  DISZ INFINITY
SURF 1
  STOP
  CURV 0.005
  TYPE STANDARD
  DIAM 12.5 1 0 0
  MEMA 12.5 1 0 0
  DISZ 7.5
  GLAS ZNSE
SURF 2
  CURV -0.005
  TYPE STANDARD
  DIAM 12.5 1 0 0
  MEMA 12.5 1 0 0
  DISZ 0
SURF 3
  TYPE STANDARD
  CURV 0.0
  SLAB 4
  DISZ 70.50101483862669
  MAZH 0 0
SURF 4
  TYPE STANDARD
  CURV 0.0
  DISZ 0`)
})

test('POCC wo aspheres', () => {
  const zemaxText = serializeToZemax(
    new Lens(12.5, 2, Material.Silicon, new Surface(12.5, -1 / 125), new Surface(12.5, 0)),
    THREE_MICRON_SOURCE
  )

  expect(zemaxText).toBe(`MODE SEQ
UNIT MM X W X CM MR CPMM
ENPD 10
ENVD 20 1 0
GFAC 0 0
GCAT SCHOTT MISC INFRARED
RAIM 0 0 1 1 0 0 0 0 0 1
FTYP 0 0 1 1 0 0 0 1
WAVM 1 3.39 1
PWAV 1
POLS 1 0 1 0 0 1 0
GLRS 1 0
GSTD 0 100.000 100.000 100.000 100.000 100.000 100.000 0 1 1 0 0 1 1 1 1 1 1
NSCD 100 500 0 0.001 10 9.9999999999999995e-07 0 0 0 0 0 0 1000000 0 2
COFN QF "COATING.DAT" "SCATTER_PROFILE.DAT" "ABG_DATA.DAT" "PROFILE.GRD"
COFN COATING.DAT SCATTER_PROFILE.DAT ABG_DATA.DAT PROFILE.GRD
LUID 4
SURF 0
  TYPE STANDARD
  CURV 0.0
  DISZ INFINITY
SURF 1
  STOP
  CURV -0.008
  TYPE STANDARD
  DIAM 6.25 1 0 0
  MEMA 6.25 1 0 0
  DISZ 2
  GLAS SILICON
SURF 2
  CURV 0
  TYPE STANDARD
  DIAM 6.25 1 0 0
  MEMA 6.25 1 0 0
  DISZ 0
SURF 3
  TYPE STANDARD
  CURV 0.0
  SLAB 4
  DISZ -52.04828484477509
  MAZH 0 0
SURF 4
  TYPE STANDARD
  CURV 0.0
  DISZ 0`)
})

test('BICC w S1 asphere', () => {
  const zemaxText = serializeToZemax(
    new Lens(
      12.5,
      2,
      Material.ZnS,
      new Surface(12.5, -1 / 50, -1, [2.285e-5, -2.318e-8, 3e-12, -4e-16]),
      new Surface(12.5, 1 / 50)
    ),
    THREE_MICRON_SOURCE
  )

  expect(zemaxText).toBe(`MODE SEQ
UNIT MM X W X CM MR CPMM
ENPD 10
ENVD 20 1 0
GFAC 0 0
GCAT SCHOTT MISC INFRARED
RAIM 0 0 1 1 0 0 0 0 0 1
FTYP 0 0 1 1 0 0 0 1
WAVM 1 3.39 1
PWAV 1
POLS 1 0 1 0 0 1 0
GLRS 1 0
GSTD 0 100.000 100.000 100.000 100.000 100.000 100.000 0 1 1 0 0 1 1 1 1 1 1
NSCD 100 500 0 0.001 10 9.9999999999999995e-07 0 0 0 0 0 0 1000000 0 2
COFN QF "COATING.DAT" "SCATTER_PROFILE.DAT" "ABG_DATA.DAT" "PROFILE.GRD"
COFN COATING.DAT SCATTER_PROFILE.DAT ABG_DATA.DAT PROFILE.GRD
LUID 4
SURF 0
  TYPE STANDARD
  CURV 0.0
  DISZ INFINITY
SURF 1
  STOP
  CURV -0.02
  CONI -1
  XDAT 1 5.0
  XDAT 2 1.0
  XDAT 3 0.0
  XDAT 4 0.00002285
  XDAT 5 -2.318e-8
  XDAT 6 3e-12
  XDAT 7 -4e-16
  TYPE XASPHERE
  DIAM 6.25 1 0 0
  MEMA 6.25 1 0 0
  DISZ 2
  GLAS ZNS_BROAD
SURF 2
  CURV 0.02
  TYPE STANDARD
  DIAM 6.25 1 0 0
  MEMA 6.25 1 0 0
  DISZ 0
SURF 3
  TYPE STANDARD
  CURV 0.0
  SLAB 4
  DISZ -20.138808841397427
  MAZH 0 0
SURF 4
  TYPE STANDARD
  CURV 0.0
  DISZ 0`)
})

test('BICX w S2 asphere', () => {
  const zemaxText = serializeToZemax(
    new Lens(
      25.4,
      4,
      Material.FusedSilica,
      new Surface(25.4, 1 / 75),
      new Surface(25.4, -1 / 75, -1.5, [1.36e-7, -3.9e-10, -3e-15, 4e-20])
    ),
    ONE_MICRON_SOURCE
  )

  expect(zemaxText).toBe(`MODE SEQ
UNIT MM X W X CM MR CPMM
ENPD 11
ENVD 20 1 0
GFAC 0 0
GCAT SCHOTT MISC INFRARED
RAIM 0 0 1 1 0 0 0 0 0 1
FTYP 0 0 1 1 0 0 0 1
WAVM 1 1.07 1
PWAV 1
POLS 1 0 1 0 0 1 0
GLRS 1 0
GSTD 0 100.000 100.000 100.000 100.000 100.000 100.000 0 1 1 0 0 1 1 1 1 1 1
NSCD 100 500 0 0.001 10 9.9999999999999995e-07 0 0 0 0 0 0 1000000 0 2
COFN QF "COATING.DAT" "SCATTER_PROFILE.DAT" "ABG_DATA.DAT" "PROFILE.GRD"
COFN COATING.DAT SCATTER_PROFILE.DAT ABG_DATA.DAT PROFILE.GRD
LUID 4
SURF 0
  TYPE STANDARD
  CURV 0.0
  DISZ INFINITY
SURF 1
  STOP
  CURV 0.013333333333333334
  TYPE STANDARD
  DIAM 12.7 1 0 0
  MEMA 12.7 1 0 0
  DISZ 4
  GLAS SILICA
SURF 2
  CURV -0.013333333333333334
  CONI -1.5
  XDAT 1 5.0
  XDAT 2 1.0
  XDAT 3 0.0
  XDAT 4 1.36e-7
  XDAT 5 -3.9e-10
  XDAT 6 -3e-15
  XDAT 7 4e-20
  TYPE XASPHERE
  DIAM 12.7 1 0 0
  MEMA 12.7 1 0 0
  DISZ 0
SURF 3
  TYPE STANDARD
  CURV 0.0
  SLAB 4
  DISZ 82.70077353750992
  MAZH 0 0
SURF 4
  TYPE STANDARD
  CURV 0.0
  DISZ 0`)
})
